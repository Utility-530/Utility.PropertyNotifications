<ResourceDictionary  x:Class="Utility.Nodify.Demo.DiagramView"
                    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
                    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                    xmlns:core="clr-namespace:Utility.Nodify.ViewModels;assembly=Utility.Nodify.ViewModels"
                    xmlns:inf="clr-namespace:Utility.Nodify.Engine.Infrastructure"
                    xmlns:inf1="clr-namespace:Utility.Nodify.Views.Infrastructure"
                    xmlns:nodify="https://miroiu.github.io/nodify"
                    xmlns:templates="http://schemas.utility.com/templates"
                    xmlns:models="clr-namespace:Utility.Nodify.Models;assembly=Utility.Nodify.Models" 
                    xmlns:beh="http://schemas.utility.com/behaviors"
                    xmlns:i="http://schemas.microsoft.com/xaml/behaviors" 
                     xmlns:local="clr-namespace:Utility.Nodify.Enums;assembly=Utility.Nodify.Enums"
                     xmlns:conv="http://schemas.utility.com/converters"
                     mc:Ignorable="d">

    <inf:PointConverter x:Key="PointConverter"/>
    <inf:ArrangementConverter x:Key="ArrangementConverter"/>
    <inf1:NodeTemplateSelector x:Key="NodeTemplateSelector">
        <inf1:NodeTemplateSelector.ObservableTemplate>
            <DataTemplate>
                <TextBlock Text="{Binding Reference.Name}" FontSize="16" FontWeight="DemiBold"></TextBlock>
            </DataTemplate>
        </inf1:NodeTemplateSelector.ObservableTemplate>
        <inf1:NodeTemplateSelector.ValueModelTemplate>
            <DataTemplate>
                <TextBlock Text="{Binding Name}" FontSize="16" FontWeight="DemiBold"></TextBlock>
            </DataTemplate>
        </inf1:NodeTemplateSelector.ValueModelTemplate>
    </inf1:NodeTemplateSelector>

    <Style x:Key="ConnectionStyle"
               TargetType="{x:Type nodify:BaseConnection}"
               BasedOn="{StaticResource {x:Type nodify:BaseConnection}}">
        <!--<Setter Property="IsAnimatingDirectionalArrows" Value="True"></Setter>-->
        <Setter Property="DirectionalArrowsAnimationDuration" Value="1"></Setter>
        <Setter Property="DirectionalArrowsCount" Value="1"></Setter>
    </Style>

    <DataTemplate x:Key="ConnectionTemplate"
                    DataType="{x:Type models:ConnectionViewModel}">
        <nodify:LineConnection Source="{Binding Output.Anchor, Converter={StaticResource PointConverter}}"    
                                    Target="{Binding Input.Anchor, Converter={StaticResource PointConverter}}"
                                    Style="{StaticResource ConnectionStyle}"
                                    SourceOffset="10 0"
                                    TargetOffset="20 0"
                                    SourceOffsetMode="Circle" >
            <i:Interaction.Behaviors>
                <inf1:TransferBehavior/>
            </i:Interaction.Behaviors>
        </nodify:LineConnection>
    </DataTemplate>

    <DataTemplate x:Key="ConnectionBaseTemplate"
                    DataType="{x:Type models:ConnectionViewModel}">
        <nodify:Connection Source="{Binding Output.Anchor, Converter={StaticResource PointConverter}}"    
                                    Target="{Binding Input.Anchor, Converter={StaticResource PointConverter}}"
                                    Style="{StaticResource ConnectionStyle}"
                                    SourceOffset="10 0"
                                    TargetOffset="20 0"
                                    SourceOffsetMode="Circle" >
            <i:Interaction.Behaviors>
                <inf1:TransferBehavior ></inf1:TransferBehavior>
            </i:Interaction.Behaviors>
        </nodify:Connection>
    </DataTemplate>

    <DataTemplate x:Key="PendingConnectionTemplate"
                    DataType="{x:Type models:PendingConnectionViewModel}">
        <nodify:PendingConnection IsVisible="{Binding IsVisible}"
                                    Source="{Binding Source, Mode=OneWayToSource}"
                                    Target="{Binding Target, Mode=OneWayToSource}"
                                    TargetAnchor="{Binding TargetLocation, Mode=OneWayToSource, Converter={StaticResource PointConverter}}"
                                    StartedCommand="{Binding DataContext.StartConnectionCommand, RelativeSource={RelativeSource AncestorType={x:Type nodify:NodifyEditor}}}"
                                    CompletedCommand="{Binding DataContext.CreateConnectionCommand, RelativeSource={RelativeSource AncestorType={x:Type nodify:NodifyEditor}}}" >

        </nodify:PendingConnection>
    </DataTemplate>


    <Style x:Key="ItemContainerStyle"
               TargetType="{x:Type nodify:ItemContainer}"
               BasedOn="{StaticResource {x:Type nodify:ItemContainer}}">
        <Setter Property="Location"
                    Value="{Binding Location}" />
        <Setter Property="IsSelected"
                    Value="{Binding IsSelected}" />
        <Setter Property="ActualSize"
                    Value="{Binding Size, Mode=OneWayToSource}" />
    </Style>
    <GeometryDrawing x:Key="SmallGridGeometry"
                        Geometry="M0,0 L0,1 0.03,1 0.03,0.03 1,0.03 1,0 Z"
                        Brush="{DynamicResource GridLinesBrush}" />

    <GeometryDrawing x:Key="LargeGridGeometry"
                        Geometry="M0,0 L0,1 0.015,1 0.015,0.015 1,0.015 1,0 Z"
                        Brush="{DynamicResource GridLinesBrush}" />

    <DrawingBrush x:Key="LargeGridLinesDrawingBrush"
                        TileMode="Tile"
                        ViewportUnits="Absolute"
                        Opacity="0.5"
                        Viewport="0 0 150 150"
                        Transform="{Binding ViewportTransform, ElementName=Editor}"
                        Drawing="{StaticResource LargeGridGeometry}" />

    <DrawingBrush x:Key="SmallGridLinesDrawingBrush"
                        TileMode="Tile"
                        ViewportUnits="Absolute"
                        Viewport="0 0 15 15"
                        Transform="{Binding ViewportTransform, ElementName=Editor}"
                        Drawing="{StaticResource SmallGridGeometry}" />

    <DataTemplate DataType="{x:Type core:DiagramViewModel}">
        <Grid MinWidth="300" MinHeight="300" VerticalAlignment="Stretch" HorizontalAlignment="Stretch" >
            <nodify:NodifyEditor DataContext="{Binding }"               
                                  
                                 ItemsSource="{Binding Nodes}"
                                Connections="{Binding Connections}"
                                SelectedItems="{Binding SelectedNodes}"
                                DisconnectConnectorCommand="{Binding DisconnectConnectorCommand}"
                                PendingConnection="{Binding PendingConnection}"
                                PendingConnectionTemplate="{StaticResource PendingConnectionTemplate}"
                                ConnectionTemplate="{StaticResource ConnectionTemplate}"
                                Background="{StaticResource SmallGridLinesDrawingBrush}"
                                ItemContainerStyle="{StaticResource ItemContainerStyle}"
                                Arrangement="{Binding Arrangement, Converter={StaticResource ArrangementConverter}}"
                                GridCellSize="15"                         
                                x:Name="Editor">
                <i:Interaction.Behaviors>
                    <inf1:ViewPortBehavior/>
                </i:Interaction.Behaviors>
                <nodify:NodifyEditor.Resources>
                    <Style TargetType="{x:Type nodify:NodeInput}"
                        BasedOn="{StaticResource {x:Type nodify:NodeInput}}">
                        <Setter Property="Header"
                            Value="{Binding Data}" />
                        <Setter Property="IsConnected"
                            Value="{Binding IsConnected}" />
                        <Setter Property="Anchor"
                            Value="{Binding Anchor, Mode=OneWayToSource, Converter={StaticResource PointConverter}}" />
                        <Setter Property="ToolTip"
                            Value="{Binding Value}" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Data.IsExecuting}" Value="True">
                                <Setter Property="Background" Value="Moccasin"></Setter>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>

                    <Style TargetType="{x:Type nodify:NodeOutput}"
                        BasedOn="{StaticResource {x:Type nodify:NodeOutput}}">
                        <Setter Property="Header"
                            Value="{Binding Data}" />
                        <Setter Property="IsConnected"
                            Value="{Binding IsConnected}" />
                        <Setter Property="Anchor"
                            Value="{Binding Anchor, Mode=OneWayToSource, Converter={StaticResource PointConverter}}" />
                        <!--<Style.Triggers>
                            <DataTrigger Binding="{Binding Data.IsActive}" Value="True">
                                <Setter Property="Background" Value="LightCoral"></Setter>
                            </DataTrigger>
                        </Style.Triggers>-->
                    </Style>

                    <DataTemplate DataType="{x:Type models:NodeViewModel}">
                        <nodify:Node 
                                    Input="{Binding Input}"
                                    Output="{Binding Output}"
                                    Content="{Binding Data}"   
                                    ContentTemplateSelector="{StaticResource NodeTemplateSelector}"
                                    Padding="5 0 0 0" >
                            <nodify:Node.Style>
                                <Style TargetType="{x:Type nodify:Node}"
                                    BasedOn="{StaticResource {x:Type nodify:Node}}">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Data.IsActive}"
                                                    Value="True">
                                            <Setter Property="ContentBrush"
                                                Value="{DynamicResource ActiveStateBrush}" />
                                            <DataTrigger.EnterActions>
                                                <BeginStoryboard>
                                                    <Storyboard RepeatBehavior="Forever">
                                                        <ColorAnimation Storyboard.TargetProperty="BorderBrush.Color"
                                                From="Transparent" To="Cyan" 
                                                Duration="0:0:1" AutoReverse="True"/>
                                                        <!--<ThicknessAnimation Storyboard.TargetProperty="BorderThickness"
                                                    From="2" To="4" Duration="0:0:1" AutoReverse="True"/>-->
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </DataTrigger.EnterActions>
                                            <DataTrigger.ExitActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <ColorAnimation Storyboard.TargetProperty="BorderBrush.Color"
                                                To="Transparent" Duration="0:0:0.3"/>
                                                        <!--<ThicknessAnimation Storyboard.TargetProperty="BorderThickness"
                                                    To="2" Duration="0:0:0.3"/>-->
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </DataTrigger.ExitActions>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Data.Exception, Converter={x:Static conv:InverseNullToBooleanConverter.Instance}}"
                                                    Value="True">
                                            <Setter Property="BorderBrush"
                                                Value="Red" />
                                            <Setter Property="ContentBrush"
                                                Value="Red" />
                                        </DataTrigger>
                                    </Style.Triggers>

                                    <Setter Property="VerticalAlignment" Value="Stretch"></Setter>
                                    <Setter Property="HorizontalAlignment" Value="Stretch"></Setter>
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"></Setter>
                                    <Setter Property="VerticalContentAlignment" Value="Stretch"></Setter>

                                    <Setter Property="BorderBrush">
                                        <Setter.Value>
                                            <SolidColorBrush Color="Transparent"/>
                                        </Setter.Value>
                                    </Setter>
                                    <Setter Property="BorderThickness" Value="4"/>

                                </Style>
                            </nodify:Node.Style>
                        </nodify:Node>
                    </DataTemplate>
                </nodify:NodifyEditor.Resources>

                <nodify:NodifyEditor.InputBindings>
                    <KeyBinding Key="Delete"
                            Command="{Binding DeleteSelectionCommand}" />
                    <KeyBinding Key="C"
                            Command="{Binding GroupSelectionCommand}" />
                </nodify:NodifyEditor.InputBindings>

                <CompositeCollection>
                    <nodify:DecoratorContainer DataContext="{Binding Menu}"
                                           Location="{Binding Location}">
                        <ContentControl Content="{Binding}"/>
                    </nodify:DecoratorContainer>
                </CompositeCollection>
            </nodify:NodifyEditor>

            <Grid Background="{StaticResource LargeGridLinesDrawingBrush}"
              Panel.ZIndex="-2" />

            <Button Content="Fit To Screen" Width="100" Height="20" VerticalAlignment="Top" HorizontalAlignment="Left">
                <i:Interaction.Triggers>
                    <i:EventTrigger EventName="Click">
                        <beh:CallMethodAction MethodName="FitToScreen" TargetObject="{Binding ElementName=Editor}"/>
                    </i:EventTrigger>
                </i:Interaction.Triggers>
            </Button>
        </Grid>
    </DataTemplate>


    <ControlTemplate x:Key="SquareConnector"
                         TargetType="Control">
        <Rectangle Width="14"
                   Fill="BlueViolet"
                       Height="14"
                       StrokeDashCap="Round"
                       StrokeLineJoin="Round"
                       StrokeStartLineCap="Round"
                       StrokeEndLineCap="Round"
                       StrokeThickness="2" />
    </ControlTemplate>

    <ControlTemplate x:Key="TriangleConnector"
                         TargetType="Control">
        <Polygon Width="14"
                     Height="14"
                 Fill="Blue"
                     Points="1,13 13,13 7,1"
                     StrokeDashCap="Round"
                     StrokeLineJoin="Round"
                     StrokeStartLineCap="Round"
                     StrokeEndLineCap="Round"
                     StrokeThickness="2" />
    </ControlTemplate>

    <Style TargetType="{x:Type nodify:NodeInput}"
                       BasedOn="{StaticResource {x:Type nodify:NodeInput}}">
        <Style.Triggers>
            <DataTrigger Binding="{Binding Shape}"
                                     Value="{x:Static local:ConnectorShape.Square}">
                <Setter Property="ConnectorTemplate"
                                    Value="{StaticResource SquareConnector}" />
                <!--<Setter Property="BorderBrush"
                                    Value="{StaticResource SquareConnectorColor}" />-->
                <Setter Property="HeaderTemplate">
                    <Setter.Value>
                        <DataTemplate DataType="{x:Type models:ConnectorViewModel}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Title}"
                                                       Margin="0 0 5 0" />
                                <TextBox Text="{Binding MaxConnections}"
                                                     MinWidth="30" />
                            </StackPanel>
                        </DataTemplate>
                    </Setter.Value>
                </Setter>
            </DataTrigger>
            <DataTrigger Binding="{Binding Shape}"
                                     Value="{x:Static local:ConnectorShape.Triangle}">
                <Setter Property="ConnectorTemplate"
                                    Value="{StaticResource TriangleConnector}" />
                <!--<Setter Property="BorderBrush"
                                    Value="{StaticResource TriangleConnectorColor}" />-->
                <Setter Property="HeaderTemplate">
                    <Setter.Value>
                        <DataTemplate DataType="{x:Type models:ConnectorViewModel}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Title}"
                                                       Margin="0 0 5 0"
                                                       VerticalAlignment="Center" />
                                <CheckBox />
                            </StackPanel>
                        </DataTemplate>
                    </Setter.Value>
                </Setter>
            </DataTrigger>
        </Style.Triggers>
    </Style>

    <Style TargetType="{x:Type nodify:NodeOutput}"
                       BasedOn="{StaticResource {x:Type nodify:NodeOutput}}">
        <Style.Triggers>
            <DataTrigger Binding="{Binding Shape}"
                                     Value="{x:Static local:ConnectorShape.Square}">
                <Setter Property="ConnectorTemplate"
                                    Value="{StaticResource SquareConnector}" />
                <!--<Setter Property="BorderBrush"
                                    Value="{StaticResource SquareConnectorColor}" />-->
                <Setter Property="HeaderTemplate">
                    <Setter.Value>
                        <DataTemplate DataType="{x:Type models:ConnectorViewModel}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Title}"
                                                       Margin="0 0 5 0" />
                                <TextBox Text="{Binding MaxConnections}"
                                                     MinWidth="30" />
                            </StackPanel>
                        </DataTemplate>
                    </Setter.Value>
                </Setter>
            </DataTrigger>
            <DataTrigger Binding="{Binding Shape}"
                                     Value="{x:Static local:ConnectorShape.Triangle}">
                <Setter Property="ConnectorTemplate"
                                    Value="{StaticResource TriangleConnector}" />
                <!--<Setter Property="BorderBrush"
                                    Value="{StaticResource TriangleConnectorColor}" />-->
                <Setter Property="HeaderTemplate">
                    <Setter.Value>
                        <DataTemplate DataType="{x:Type models:ConnectorViewModel}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Title}"
                                                       Margin="0 0 5 0"
                                                       VerticalAlignment="Center" />
                                <CheckBox />
                            </StackPanel>
                        </DataTemplate>
                    </Setter.Value>
                </Setter>
            </DataTrigger>
        </Style.Triggers>
    </Style>


</ResourceDictionary>
