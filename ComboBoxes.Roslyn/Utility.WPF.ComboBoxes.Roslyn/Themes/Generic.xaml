<ResourceDictionary x:Class="Utility.WPF.ComboBoxes.Roslyn.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:Utility.WPF.ComboBoxes.Roslyn"
             xmlns:cmb="http://schemas.utility.com/ComboBoxes"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:ref="clr-namespace:System.Reflection;assembly=System.Reflection"
             xmlns:po="http://schemas.microsoft.com/winfx/2006/xaml/presentation/options">


    <local:SymbolConverter x:Key="SymbolConverter"/>
    <local:HighlightTextConverter x:Key="HighlightTextConverter"/>
    <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    <local:IndexItemConverter x:Key="IndexItemConverter"/>

    <DataTemplate x:Key="HighlightTemplate">
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Name with Highlighting -->
            <ItemsControl Grid.Column="0" Margin="0,0,8,0">
                <ItemsControl.ItemsSource>
                    <MultiBinding Converter="{StaticResource HighlightTextConverter}" 
                       ConverterParameter="Name">
                        <Binding Path="."/>
                        <Binding Path="(cmb:FilterBehavior.SearchText)" RelativeSource="{RelativeSource AncestorType=ComboBox}"/>
                    </MultiBinding>
                </ItemsControl.ItemsSource>
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <TextBlock FontSize="12" 
                        FontFamily="Consolas"
                        Text="{Binding Text}">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsMatch}" Value="True">
                                            <Setter Property="FontWeight" Value="ExtraBold"/>
                                            <!--<Setter Property="Foreground" Value="#4EC9B0"/>-->
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Namespace -->
            <TextBlock Grid.Column="1" 
            FontSize="8" 
            FontFamily="Consolas"
            Foreground="#808080" 
            VerticalAlignment="Center"
            Text="{Binding ConverterParameter='Alternate', 
                          Converter={StaticResource SymbolConverter}}" />
        </Grid>
    </DataTemplate>

    <VisualBrush x:Key="HatchBrush" TileMode="Tile"
            Viewport="0,0,5,5" ViewportUnits="Absolute"
            Viewbox="0,0,5,5" ViewboxUnits="Absolute"
            po:Freeze="True">
        <VisualBrush.Visual>
            <Path Data="M 0 5 L 5 0 M -2 2 L 2 -2 M 3 7 L 7 3"
             Stroke="WhiteSmoke" StrokeEndLineCap="Square"
             RenderOptions.EdgeMode="Aliased" />
        </VisualBrush.Visual>
    </VisualBrush>

    <Style x:Key="VisualStudio_Roslyn_Style" TargetType="{x:Type ComboBox}">
        <Setter Property="StaysOpenOnEdit" Value="True"></Setter>
        <Setter Property="Height" Value="24"></Setter>
        <Setter Property="Width" Value="400"></Setter>
        <Setter Property="ItemTemplate" Value="{StaticResource HighlightTemplate}"/>
        <Setter Property="Background" Value="Transparent"/>
        <Setter Property="cmb:ComboBoxEx.ToggleButtonStyle" >
            <Setter.Value>
                <Style TargetType="ToggleButton">
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ToggleButton">
                                <Border x:Name="Border" 
                           Background="White"
                           BorderBrush="#CCCCCC" 
                           BorderThickness="1">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition/>
                                            <ColumnDefinition Width="0"/>
                                        </Grid.ColumnDefinitions>
                                        <Path Grid.Column="1"
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center"
                                 Data="M 0 0 L 4 4 L 8 0 Z"
                                 Fill="#666666"/>
                                    </Grid>
                                </Border>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </Setter.Value>
        </Setter>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type ComboBox}">
                    <Grid>
                        <ToggleButton x:Name="ToggleButton"                                    
                                      Focusable="False"
                                      IsChecked="{Binding IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                      ClickMode="Press"
                                      Style="{Binding Path=(cmb:ComboBoxEx.ToggleButtonStyle), RelativeSource={RelativeSource AncestorType=ComboBox}}">

                        </ToggleButton>

                        <ContentPresenter x:Name="ContentSite"
                                                            Margin="6,3,3,3"
                                                            Content="{Binding Path=(cmb:FilterBehavior.SelectedItem), RelativeSource={RelativeSource AncestorType=ComboBox}}"
                                                            VerticalAlignment="Center"
                                                            HorizontalAlignment="Left"                                                          
                                                            IsHitTestVisible="False">
                            <ContentPresenter.ContentTemplate>
                                <DataTemplate>
                                    <TextBlock FontSize="12" 
                                                                 FontWeight="ExtraBold"
                                                                 FontFamily="Consolas"
                                                                 Text="{Binding Converter={StaticResource SymbolConverter}, ConverterParameter='Selected'}">

                                    </TextBlock>
                                </DataTemplate>
                            </ContentPresenter.ContentTemplate>

                        </ContentPresenter>

                        <TextBox x:Name="PART_Custom_EditableTextBox"
                                             Margin="3,3,3,3"
                                             Background="Transparent"                                      
                                             FontSize="12" 
                                             FontFamily="Consolas"
                                             FontWeight="ExtraBold"
                                             IsEnabled="True"
                                             IsReadOnly="{TemplateBinding IsReadOnly}"
                                             Focusable="True"/>


                        <WrapPanel HorizontalAlignment="Right" Visibility="{Binding Path=(cmb:FilterBehavior.IsDebugging) , RelativeSource={RelativeSource AncestorType=ComboBox}, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <TextBlock FontSize="8" Text="IsEditing"></TextBlock>
                            <CheckBox   HorizontalAlignment="Right" IsChecked="{Binding Path=(cmb:FilterBehavior.IsEditing) , RelativeSource={RelativeSource AncestorType=ComboBox}}"></CheckBox>
                            <TextBlock FontSize="8" Text="Index"></TextBlock>
                            <TextBlock  HorizontalAlignment="Right" Text="{Binding Path=(cmb:FilterBehavior.Index) , RelativeSource={RelativeSource AncestorType=ComboBox}}"></TextBlock>
                            <TextBlock FontSize="8" Text="Progress"></TextBlock>
                            <TextBlock   HorizontalAlignment="Right" Text="{Binding Path=(cmb:FilterBehavior.Progress) , RelativeSource={RelativeSource AncestorType=ComboBox}}"></TextBlock>
                            <TextBlock FontSize="8" Text="SearchText"></TextBlock>
                            <TextBlock  HorizontalAlignment="Right" Text="{Binding Path=(cmb:FilterBehavior.SearchText) , RelativeSource={RelativeSource AncestorType=ComboBox}}"></TextBlock>
                        </WrapPanel>
                        <ProgressBar Height="2" HorizontalAlignment="Stretch" 
                                             VerticalAlignment="Bottom"
                                             Minimum="0" Maximum="100" 
                                             Foreground="#4EC9B0"
                                             Value="{Binding Path=(cmb:FilterBehavior.Progress), 
                                                FallbackValue=50,
                                                TargetNullValue=50,
                                                RelativeSource={RelativeSource AncestorType=ComboBox}}">
                        </ProgressBar>
            
                        <Popup x:Name="Popup"
                                 Placement="Bottom"
                                   Width="{TemplateBinding Width}"
                                   StaysOpen="True"
                                 AllowsTransparency="True"
                                 Focusable="False"
                                 PopupAnimation="Slide">
                            <Grid MinWidth="{TemplateBinding ActualWidth}"
                                    MaxHeight="{TemplateBinding MaxDropDownHeight}"
                                  Background="{TemplateBinding Background}">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"></RowDefinition>
                                    <RowDefinition Height="*"></RowDefinition>
                                </Grid.RowDefinitions>
                                <ItemsControl 
                                    ItemsSource="{Binding Path=(cmb:FilterBehavior.Filters), RelativeSource={RelativeSource AncestorType=ComboBox}}"
                                    ItemTemplateSelector="{Binding Path=(cmb:FilterBehavior.FiltersTemplateSelector), RelativeSource={RelativeSource AncestorType=ComboBox}}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel></WrapPanel>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                </ItemsControl>

                                <Border Grid.Row="1"
                                          BorderBrush="#3F3F46"
                                          BorderThickness="1">
                                    <ScrollViewer>
                                        <ItemsPresenter/>
                                    </ScrollViewer>
                                </Border>
                            </Grid>
                        </Popup>
                    </Grid>
                    <ControlTemplate.Triggers>
                        <!-- Use DataTrigger instead of Trigger -->
                        <DataTrigger 
                                      Binding="{Binding Path=(cmb:FilterBehavior.IsEditing), 
                                 RelativeSource={RelativeSource Self}}" 
                                      Value="False">
                            <Setter TargetName="PART_Custom_EditableTextBox" Property="Visibility" Value="Collapsed"/>
                            <Setter TargetName="ContentSite" Property="Visibility" Value="Visible"/>
                        </DataTrigger>

                        <DataTrigger Binding="{Binding Path=(cmb:FilterBehavior.IsEditing), 
                                 RelativeSource={RelativeSource Self}}" 
                                               Value="True">
                            <Setter TargetName="PART_Custom_EditableTextBox" Property="Visibility" Value="Visible"/>
                            <Setter TargetName="ContentSite" Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
               
                        <!--<DataTrigger Binding="{Binding Path=(cmb:FilterBehavior.Progress),                                        
                                      RelativeSource={RelativeSource Self}}" 
                                               Value='100'>
                                      <Setter TargetName="PART_Custom_EditableTextBox" Property="IsEnabled" Value="True"/>

                                  </DataTrigger>-->
                    </ControlTemplate.Triggers>


                </ControlTemplate>
            </Setter.Value>
        </Setter>
        <Setter Property="ItemContainerStyle">
            <Setter.Value>
                <Style TargetType="ComboBoxItem">
                    <Setter Property="Padding" Value="6,4"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ComboBoxItem">
                                <Border x:Name="Border"                
                  BorderThickness="0"
                  Background="{StaticResource HatchBrush}"
                  Padding="{TemplateBinding Padding}">
                                    <ContentPresenter/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <!-- Hover State -->
                                    <!--<Trigger Property="IsMouseOver" Value="True">
                          <Setter TargetName="Border" Property="Background" Value="#1F1F1F"/>
                      </Trigger>-->
                                    <!-- Selected State -->
                                    <!--<Trigger Property="IsHighlighted" Value="True">
                          <Setter TargetName="Border" Property="Background" Value="#094771"/>
                      </Trigger>-->
                                    <!--<Trigger Property="IsSelected" Value="True">
                          <Setter TargetName="Border" Property="Background" Value="#094771"/>
                      </Trigger>-->

                                    <DataTrigger Value="True">
                                        <DataTrigger.Binding>
                                            <MultiBinding Converter="{StaticResource IndexItemConverter}">
                                                <Binding RelativeSource="{RelativeSource FindAncestor, AncestorType={x:Type ItemsControl}}" />
                                                <Binding RelativeSource="{RelativeSource Self}" />
                                                <Binding Path="(cmb:FilterBehavior.Index)" RelativeSource="{RelativeSource FindAncestor, AncestorType={x:Type ItemsControl}}" />
                                            </MultiBinding>
                                        </DataTrigger.Binding>
                                        <Setter TargetName="Border" Property="Background" Value="#094771"/>
                                    </DataTrigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </Setter.Value>
        </Setter>
        <Setter Property="ItemsPanel">
            <Setter.Value>
                <ItemsPanelTemplate>
                    <VirtualizingStackPanel/>
                </ItemsPanelTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <Style x:Key="HeaderedContentControlStyle" TargetType="HeaderedContentControl">
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="HeaderedContentControl">
                    <Border Background="#F5F5F5" CornerRadius="4">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="0.1*"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="0.5*"/>
                            </Grid.RowDefinitions>

                            <Border Grid.Row="1" Background="GhostWhite" 
                                Padding="16,12" HorizontalAlignment="Center">
                                <ContentPresenter ContentSource="Header"
                                            TextElement.Foreground="Gray"
                                            TextElement.FontSize="16"
                                            TextElement.FontWeight="Medium"/>
                            </Border>

                            <ContentPresenter Grid.Row="2" Margin="8"/>
                        </Grid>
                    </Border>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>
</ResourceDictionary>
